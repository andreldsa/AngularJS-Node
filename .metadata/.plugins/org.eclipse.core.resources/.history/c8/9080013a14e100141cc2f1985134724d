var app = angular.module('app', [ 'ngRoute', 'controllers', 'seo' ]);

app.config([ '$routeProvider', function($routeProvider) {
	$routeProvider.when('/home', {
		templateUrl : 'partials/home.html',
		controller : 'HomeCtrl'
	}).when('/about', {
		templateUrl : 'partials/about.html'
	}).when('/contact', {
		templateUrl : 'partials/contact.html'
	}).when('/rs/new', {
		templateUrl : 'partials/rs_form.html',
		controller : 'RealStateCtrl',
		resolve : {
			auth : [ "$q", "AuthenticationService", function($q, AuthenticationService) {
				var userInfo = AuthenticationService.getUserInfo();

				if (userInfo) {
					return $q.when(userInfo);
				} else {
					return $q.reject({
						authenticated : false
					});
				}
			} ]
		}
	}).when('/rs/update/:rsID', {
		templateUrl : 'partials/rs_form.html',
		controller : 'RealStateCtrl',
		resolve : {
			auth : [ "$q", "AuthenticationService", function($q, AuthenticationService) {
				var userInfo = AuthenticationService.getUserInfo();

				if (userInfo) {
					return $q.when(userInfo);
				} else {
					return $q.reject({
						authenticated : false
					});
				}
			} ]
		}
	}).when('/slide/new', {
		templateUrl : 'partials/slide_form.html',
		controller : 'FormSlideCtrl',
		resolve : {
			auth : [ "$q", "AuthenticationService", function($q, AuthenticationService) {
				var userInfo = AuthenticationService.getUserInfo();

				if (userInfo) {
					return $q.when(userInfo);
				} else {
					return $q.reject({
						authenticated : false
					});
				}
			} ]
		}
	}).when('/slide/:sID', {
		templateUrl : 'partials/slide_form.html',
		controller : 'FormSlideCtrl',
		resolve : {
			auth : [ "$q", "AuthenticationService", function($q, AuthenticationService) {
				var userInfo = AuthenticationService.getUserInfo();

				if (userInfo) {
					return $q.when(userInfo);
				} else {
					return $q.reject({
						authenticated : false
					});
				}
			} ]
		}
	}).when('/slides', {
		templateUrl : 'partials/slides.html',
		controller : 'SlidesCtrl',
		resolve : {
			auth : [ "$q", "AuthenticationService", function($q, AuthenticationService) {
				var userInfo = AuthenticationService.getUserInfo();

				if (userInfo) {
					return $q.when(userInfo);
				} else {
					return $q.reject({
						authenticated : false
					});
				}
			} ]
		}
	}).when('/rs/:rsID', {
		templateUrl : 'partials/rs_details.html',
		controller : 'RSDetailsCtrl'
	}).when('/rs/all/sell', {
		templateUrl : 'partials/to_sell.html',
		controller : 'SellCtrl'
	}).when('/rs/all/rent', {
		templateUrl : 'partials/to_rent.html',
		controller : 'RentCtrl'
	}).when('/login', {
		templateUrl : 'partials/login.html',
		controller : 'LoginCtrl'
	}).otherwise({
		redirectTo : '/home'
	});
} ]);

app.run([ "$rootScope", "$location", function($rootScope, $location) {
	$rootScope.$on("$routeChangeError", function(event, current, previous, eventObj) {
		if (eventObj.authenticated === false) {
			$location.path("/login");
		}
	});
} ]);

// Directives

app.directive('message', function() {
	return {
		restrict : 'A',
		controller : function($scope) {
			$scope.hasMessage = function() {
				return $scope.message != undefined
			}
			$scope.clearMessage = function() {
				$scope.message = undefined
			}
		},
		templateUrl : 'directives/message.html'
	}
});

app.directive('contact', function() {
	return {
		restrict : 'A',
		scope: {
			title: '@title'
		},
		controller : function($scope, ContactService) {
			$scope.formData = {
					inputSubject: $scope.title
			}
			$scope.submitButtonDisabled = false;
			$scope.submitted = false; 
			$scope.submit = function(contactform) {
				$scope.submitted = true;
				$scope.submitButtonDisabled = true;
				if (contactform.$valid) {
					ContactService.sendMessage($scope.formData).then(function(result) {
						$scope.submitButtonDisabled = true;
						$scope.message = {
								type : 'alert-success',
								content : result.message
							}
					}, function(error) {
						$scope.submitButtonDisabled = false;
						$scope.message = {
								type : 'alert-danger',
								content : error.message
							}
					})
				} else {
					$scope.submitButtonDisabled = false;
					$scope.message = {
							type : 'alert-danger',
							content : 'Campos obrigat√≥rios'
						}
				}
			}
		},
		templateUrl : 'directives/contact.html'
	}
});

app.directive("card", function() {
	return {
		restrict : "E",
		templateUrl : "directives/card.html"
	}
})